name: Redirect to new site

on:
    push:
        branches:
            - main
            - master
    workflow_dispatch:

permissions:
    contents: read
    pages: write
    id-token: write

concurrency:
    group: "pages"
    cancel-in-progress: true

jobs:
    deploy:
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        steps:
            - name: Create redirect file
              run: |
                  mkdir -p public
                  cat > public/index.html <<'EOF'
                  <!DOCTYPE html>
                  <html lang="en">
                  <head>
                    <meta charset="UTF-8">
                    <meta http-equiv="refresh" content="0; url=https://esscommunity.org/aiml-blogs/">
                    <link rel="canonical" href="https://esscommunity.org/aiml-blogs/">
                    <title>Redirecting…</title>
                  </head>
                  <body>
                    <p>Redirecting to <a href="https://esscommunity.org/aiml-blogs/">the new blog</a>…</p>
                    <script>
                      const base = "https://esscommunity.org/aiml-blogs/";
                      // Remove any leading "/blogs" or trailing slashes before appending
                      let path = window.location.pathname
                        .replace(/^\/blogs\/?/, "")  // remove leading /blogs/
                        .replace(/^\/+/, "");        // remove any extra slashes
                      const newURL = base + (path ? path : "") + window.location.search + window.location.hash;
                      window.location.replace(newURL);
                    </script>
                  </body>
                  </html>
                  EOF

            - name: Upload artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: ./public

            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
